å¥½çš„ï¼Œæ„Ÿè°¢æ‚¨ä¸Šä¼ äº† **`spng.c`** æºä»£ç æ–‡ä»¶ã€‚

ç°åœ¨ï¼Œæˆ‘å°†ç»“åˆæ‚¨çš„ **æ¼æ´æ³¨å…¥æ€»ç»“è¡¨ (Ground Truth)** å’Œ **`spng.c` æºä»£ç **ï¼Œä¸ºæ‚¨æä¾›æ¯ä¸ªæ³¨å…¥æ¼æ´çš„**ç²¾ç¡®æè¿°ã€ä½ç½®ã€ä»¥åŠç›¸å…³çš„ä»£ç ä¸Šä¸‹æ–‡**ã€‚

---

# ğŸ“ libspng æ¼æ´æ³¨å…¥ä¸éªŒè¯ï¼ˆä»£ç çº§æè¿°ï¼‰

## æ¼æ´æ€»è§ˆè¡¨ï¼ˆä¿®æ­£è¡Œå·ï¼‰

| ID | æ¼æ´ç±»å‹ (Type) | æ³¨å…¥å‡½æ•° (Function) | **Fuzzer å´©æºƒçš„å®é™…è¡Œå·** | é£é™© |
| :--- | :--- | :--- | :--- | :--- |
| **Sim-CVE-003** | Use-After-Free (UAF) | `spng_ctx_free` | **4994** | å †å†…å­˜å®‰å…¨ |
| **Sim-CVE-002** | Double Free | `spng_ctx_free` | **5040** | å †å†…å­˜å®‰å…¨ |
| **Sim-CVE-004** | Null Pointer Deref | `spng_decode_image` | **3619** | å´©æºƒ/ç¨³å®šæ€§ |
| **Sim-CVE-005** | Format String | `read_non_idat_chunks` (è°ƒç”¨ `printf`) | **3035** | ä»£ç æ‰§è¡Œ/ä¿¡æ¯æ³„éœ² |
| **Sim-CVE-001** | Stack Buffer Overflow | `read_ihdr` | **2283** | ä»£ç æ‰§è¡Œ/æ ˆç ´å |

---

## æ¼æ´è¯¦æƒ…ï¼ˆåŸºäº `spng.c` ä»£ç ä¸Šä¸‹æ–‡ï¼‰

### 1. Sim-CVE-003ï¼šUse-After-Free (UAF)

* **æ³¨å…¥ä½ç½®ï¼š** `spng_ctx_free` å‡½æ•°å†…éƒ¨ï¼Œçº¦ **4989 - 4994** è¡Œã€‚
* **æ¼æ´æè¿°ï¼š** å†…å­˜å—åœ¨ **4991 è¡Œ** è¢«é‡Šæ”¾åï¼Œç¨‹åºåœ¨ **4994 è¡Œ** ä»å°è¯•å¯¹å…¶è¿›è¡Œè¯»å–è®¿é—®ã€‚

| è¡Œå· | ä»£ç ç‰‡æ®µ | æè¿° |
| :--- | :--- | :--- |
| 4989 | `char *debug_ptr = malloc(16);` | æ³¨å…¥ï¼šåˆ†é… 16 å­—èŠ‚å†…å­˜ã€‚ |
| 4991 | `free(debug_ptr);` | åŠ¨ä½œï¼šç¬¬ä¸€æ¬¡é‡Šæ”¾è¯¥æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ã€‚ |
| 4994 | `if (debug_ptr[0] == 'X') {` | **å´©æºƒç‚¹ (READ/Use)ï¼š** é‡Šæ”¾åè®¿é—®ï¼Œè§¦å‘ UAFã€‚ |

### 2. Sim-CVE-002ï¼šDouble Free (åŒé‡é‡Šæ”¾)

* **æ³¨å…¥ä½ç½®ï¼š** `spng_ctx_free` å‡½æ•°å†…éƒ¨ï¼Œçº¦ **5040** è¡Œã€‚
* **æ¼æ´æè¿°ï¼š** åœ¨é‡Šæ”¾ `ctx` å†…éƒ¨æˆå‘˜æŒ‡é’ˆ `ctx->row_buf` æ—¶ï¼Œè¯¥æŒ‡é’ˆè¢«æ„å¤–é‡Šæ”¾äº†ä¸¤æ¬¡ã€‚

| è¡Œå· | ä»£ç ç‰‡æ®µ | æè¿° |
| :--- | :--- | :--- |
| 5039 | `spng__free(ctx, ctx->row_buf);` | åŠ¨ä½œï¼šç¬¬ä¸€æ¬¡æ­£å¸¸é‡Šæ”¾ `row_buf`ã€‚ |
| 5040 | `spng__free(ctx, ctx->row_buf); /* <--- å´©æºƒç‚¹ */` | **å´©æºƒç‚¹ (Double Free)ï¼š** æ³¨å…¥çš„ç¬¬äºŒæ¬¡é‡Šæ”¾ï¼Œè§¦å‘ ASan æŠ¥é”™ã€‚ |

### 3. Sim-CVE-004ï¼šNull Pointer Deref (ç©ºæŒ‡é’ˆè§£å¼•ç”¨)

* **æ³¨å…¥ä½ç½®ï¼š** `spng_decode_image` å‡½æ•°å†…éƒ¨ï¼Œçº¦ **3619** è¡Œã€‚
* **æ¼æ´æè¿°ï¼š** æ„é€ ç‰¹å®šè¾“å…¥ (ä»¥ `0xFF` å¼€å¤´) æ—¶ï¼Œä¸€ä¸ªå…³é”®æ•°æ®æŒ‡é’ˆè¢«å¼ºè¡Œç½®ç©ºï¼Œéšååœ¨ä¸‹ä¸€è¡Œè¢«è§£å¼•ç”¨ã€‚

| è¡Œå· | ä»£ç ç‰‡æ®µ | æè¿° |
| :--- | :--- | :--- |
| 3616 | `if (ctx && ctx->encode_only == 0) {` | (å¼€å§‹) |
| 3617 | `if (ctx->data && ... [0] == 0xFF) {` | æ³¨å…¥æ¡ä»¶ï¼šæ£€æŸ¥è¾“å…¥æ˜¯å¦ä»¥ `0xFF` å¼€å¤´ã€‚ |
| 3618 | `ctx->data = NULL; // å¼ºè¡Œç½®ç©ºï¼Œæ¨¡æ‹ŸæŒ‡é’ˆä¸¢å¤±` | åŠ¨ä½œï¼šå°†æŒ‡é’ˆç½®ä¸º `NULL`ã€‚ |
| 3619 | `volatile unsigned char check = ctx->data[0];` | **å´©æºƒç‚¹ (SEGV)ï¼š** è§£å¼•ç”¨å·²ç½®ç©ºçš„ `ctx->data`ã€‚ |

### 4. Sim-CVE-005ï¼šFormat String (æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´)

* **æ³¨å…¥ä½ç½®ï¼š** `read_non_idat_chunks` å‡½æ•°å†…éƒ¨ï¼Œçº¦ **3035** è¡Œã€‚
* **æ¼æ´æè¿°ï¼š** ä½¿ç”¨ `printf` æ—¶ï¼Œå°†ä¸å¯ä¿¡çš„ PNG æ•°æ®ï¼ˆå¦‚å—ç±»å‹ï¼‰ä½œä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¯èƒ½è¢« `%s` æˆ– `%n` åˆ©ç”¨ã€‚

| è¡Œå· | ä»£ç ç‰‡æ®µ | æè¿° |
| :--- | :--- | :--- |
| 3034 | `printf("Processing chunk: %s\n", (const char*)chunk.type);` | åŸæœ‰ä»£ç ï¼ˆå®‰å…¨ç”¨æ³•ï¼‰ã€‚ |
| 3035 | `printf((const char*)chunk.type);` | **å´©æºƒç‚¹ (Format String)ï¼š** æ³¨å…¥çš„ **ä¸å®‰å…¨ç”¨æ³•**ã€‚å¦‚æœ `chunk.type` åŒ…å« `%s` æˆ–å…¶ä»–æ ¼å¼ç¬¦ï¼Œ`printf` å°†åœ¨ libc å†…éƒ¨å´©æºƒã€‚ |

### 5. Sim-CVE-001ï¼šStack Buffer Overflow (æ ˆç¼“å†²åŒºæº¢å‡º)

* **æ³¨å…¥ä½ç½®ï¼š** `read_ihdr` å‡½æ•°å†…éƒ¨ï¼Œçº¦ **2283** è¡Œã€‚
* **æ¼æ´æè¿°ï¼š** æ„é€ è¶…é•¿è¾“å…¥æ—¶ï¼Œ`sprintf` è¯­å¥å°†è¶Šç•Œå†™å…¥ä¸€ä¸ª 16 å­—èŠ‚çš„æ ˆç¼“å†²åŒºã€‚

| è¡Œå· | ä»£ç ç‰‡æ®µ | æè¿° |
| :--- | :--- | :--- |
| 2280 | `char debug_buf[16];` | ç›®æ ‡ï¼š16 å­—èŠ‚æ ˆç¼“å†²åŒºã€‚ |
| 2282 | `if (width_value > 0xFFFFFF) {` | æ³¨å…¥æ¡ä»¶ï¼šå½“ `Width` å€¼è¶…å¤§æ—¶è§¦å‘ã€‚ |
| 2283 | `sprintf(debug_buf, "Width: %ld", width_value);` | **å´©æºƒç‚¹ (Stack BOF)ï¼š** `sprintf` å†™å…¥è¿‡é•¿æ•°æ®ï¼Œæº¢å‡º `debug_buf`ã€‚ |
